<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>كويز الكيمياء المتطور</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">


<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        
:root {



    --primary: #2E7D32;
    --secondary: #4CAF50;
    --primary-dark: #56d43a;

    --success: #4cc9f0;
    --danger: #f72585;
    --warning: #ff9f1c;
    --easy: #2ec4b6;
    --medium: #ff9f1c;
    --hard: #e71d36;
    --dark: #1a1a2e;
    --light: #f8f9fa;
    --gray: #6c757d;
    --border-radius: 12px;
    --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

body {
    font-family: 'Tajawal', sans-serif;
    background-color: #f5f7fa;
    color: var(--dark);
    line-height: 1.6;
    touch-action: manipulation;
    min-height: 100vh;
    padding: 20px;
}

.container {
    max-width: 800px;
    margin: 0 auto;
    position: relative;
}

/* شاشة البداية */
.start-screen {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    padding: 30px;
    text-align: center;
    animation: fadeIn 0.5s ease;
}

.start-screen h1 {
    color: var(--primary);
    margin-bottom: 15px;
    font-size: 2rem;
}

.start-screen p {
    color: var(--gray);
    margin-bottom: 30px;
    font-size: 1.1rem;
}

.quiz-info {
    display: flex;
    justify-content: space-around;
    margin: 25px 0;
    flex-wrap: wrap;
    gap: 15px;
}

.info-box {
    background: var(--light);
    border-radius: var(--border-radius);
    padding: 15px;
    flex: 1;
    min-width: 120px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}

.info-box i {
    font-size: 1.5rem;
    margin-bottom: 10px;
    color: var(--primary);
}

.info-box h3 {
    font-size: 1rem;
    margin-bottom: 5px;
}

.info-box p {
    font-size: 0.9rem;
    color: var(--gray);
    margin: 0;
}

.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 12px 28px;
    border-radius: 50px;
    font-weight: 700;
    cursor: pointer;
    transition: var(--transition);
    border: none;
    font-size: 1rem;
    font-family: 'Tajawal', sans-serif;
    gap: 8px;
}

.btn-primary {
    background: var(--primary);
    color: white;
    box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
}

.btn-primary:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
}

.btn-outline {
    background: transparent;
    color: var(--primary);
    border: 2px solid var(--primary);
}

.btn-outline:hover {
    background: rgba(67, 97, 238, 0.1);
}

/* شاشة الكويز */
.quiz-container {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    overflow: hidden;
    display: none;
    animation: fadeIn 0.5s ease;
}

.quiz-header {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    padding: 20px;
    position: relative;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.quiz-title {
    font-size: 1.3rem;
    font-weight: 700;
}

.question-progress {
    background: rgba(255, 255, 255, 0.2);
    padding: 5px 12px;
    border-radius: 50px;
    font-size: 0.9rem;
    font-weight: 600;
}

.progress-container {
    margin-top: 15px;
    height: 6px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 3px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: white;
    border-radius: 3px;
    transition: width 0.5s ease;
}

.timer-container {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 50px;
    height: 50px;
}

.timer-circle {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
}

.timer-background {
    fill: none;
    stroke: rgba(255, 255, 255, 0.3);
    stroke-width: 6;
}

.timer-progress {
    fill: none;
    stroke: white;
    stroke-width: 6;
    stroke-linecap: round;
    stroke-dasharray: 283;
    stroke-dashoffset: 283;
    transition: stroke-dashoffset 1s linear;
}

.timer-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-weight: 700;
    font-size: 1rem;
}

.quiz-body {
    padding: 25px;
}

.question-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.question-tag {
    padding: 5px 12px;
    border-radius: 50px;
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
}

.tag-easy {
    background: rgba(46, 196, 182, 0.1);
    color: var(--easy);
}

.tag-medium {
    background: rgba(248, 150, 30, 0.1);
    color: var(--medium);
}

.tag-hard {
    background: rgba(231, 29, 54, 0.1);
    color: var(--hard);
}

.question-points {
    background: var(--light);
    padding: 5px 12px;
    border-radius: 50px;
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--primary);
}

.question-text {
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 20px;
    line-height: 1.4;
    color: var(--dark);
}

.question-image {
    margin: 15px 0;
    text-align: center;
    border-radius: var(--border-radius);
    overflow: hidden;
    cursor: pointer;
    transition: var(--transition);
    border: 1px solid #eee;
}

.question-image:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
}

.question-image img {
    max-width: 100%;
    max-height: 250px;
    display: block;
    margin: 0 auto;
}

.options-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 25px;
}

.option {
    display: flex;
    align-items: center;
    padding: 15px 20px;
    background: var(--light);
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: var(--transition);
    border: 2px solid transparent;
    position: relative;
    overflow: hidden;
}

.option:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
}

.option.disabled {
    cursor: not-allowed;
    opacity: 0.7;
}

.option.correct {
    border-color: var(--easy);
    background: rgba(46, 196, 182, 0.1);
}

.option.incorrect {
    border-color: var(--hard);
    background: rgba(231, 29, 54, 0.1);
}

.option input {
    position: absolute;
    opacity: 0;
    cursor: pointer;
}

.option-radio {
    width: 22px;
    height: 22px;
    border: 2px solid #ddd;
    border-radius: 50%;
    margin-left: 12px;
    flex-shrink: 0;
    position: relative;
    transition: var(--transition);
}

.option input:checked ~ .option-radio {
    border-color: var(--primary);
    background-color: var(--primary);
}

.option.correct input:checked ~ .option-radio {
    border-color: var(--easy);
    background-color: var(--easy);
}

.option.incorrect input:checked ~ .option-radio {
    border-color: var(--hard);
    background-color: var(--hard);
}

.option-radio:after {
    content: "";
    position: absolute;
    display: none;
    left: 7px;
    top: 3px;
    width: 5px;
    height: 10px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}

.option input:checked ~ .option-radio:after {
    display: block;
}

.option-text {
    font-size: 1rem;
    color: var(--dark);
    flex: 1;
}

.explanation {
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: var(--border-radius);
    border-right: 4px solid var(--primary);
    display: none;
    animation: fadeIn 0.5s ease;
}

.explanation-title {
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.explanation-text {
    color: #666;
    font-size: 0.95rem;
    line-height: 1.6;
}

.quiz-footer {
    display: flex;
    justify-content: space-between;
    padding: 20px;
    border-top: 1px solid #eee;
}

/* شاشة النتائج */
.result-container {
    display: none;
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    padding: 30px;
    text-align: center;
    animation: fadeIn 0.5s ease;
}

.result-icon {
    font-size: 80px;
    margin-bottom: 20px;
    color: var(--primary);
    animation: bounce 1s;
}

.result-score {
    font-size: 2.5rem;
    font-weight: 900;
    margin-bottom: 10px;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.result-message {
    font-size: 1.2rem;
    color: var(--gray);
    margin-bottom: 25px;
}

.stats-container {
    display: flex;
    justify-content: space-around;
    margin: 30px 0;
    flex-wrap: wrap;
    gap: 15px;
}

.stat-box {
    background: var(--light);
    border-radius: var(--border-radius);
    padding: 20px;
    flex: 1;
    min-width: 150px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 5px;
}

.stat-label {
    font-size: 0.9rem;
    color: var(--gray);
}

.progress-stats {
    width: 100%;
    height: 10px;
    background: #eee;
    border-radius: 5px;
    margin: 15px 0;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    border-radius: 5px;
    transition: width 0.5s ease;
}

.progress-easy {
    background: var(--easy);
}

.progress-medium {
    background: var(--medium);
}

.progress-hard {
    background: var(--hard);
}

.buttons-container {
    display: flex;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
    margin-top: 30px;
}

/* تأثيرات الحركة */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-30px); }
    60% { transform: translateY(-15px); }
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

/* رسائل التحميل والتنبيهات */
.loading-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 5px solid rgba(67, 97, 238, 0.2);
    border-radius: 50%;
    border-top-color: var(--primary);
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
}

.loading-text {
    font-size: 1.2rem;
    color: var(--dark);
    font-weight: 500;
}

.toast {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--danger);
    color: white;
    padding: 15px 25px;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 10px;
    animation: slideIn 0.3s, fadeOut 0.5s 2.5s;
    animation-fill-mode: forwards;
}

.toast i {
    font-size: 1.2rem;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@keyframes slideIn {
    from { bottom: -50px; opacity: 0; }
    to { bottom: 30px; opacity: 1; }
}

@keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
}

/* تكبير الصور */
.zoom-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 1001;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
}

.zoom-modal.active {
    opacity: 1;
    pointer-events: all;
}

.zoom-content {
    max-width: 90%;
    max-height: 90%;
    transition: transform 0.3s;
    transform-origin: center center;
}

.zoom-close {
    position: absolute;
    top: 20px;
    right: 20px;
    color: white;
    font-size: 30px;
    cursor: pointer;
    background: rgba(0, 0, 0, 0.5);
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* التصميم المتجاوب */
@media (max-width: 768px) {
    .quiz-header {
        padding: 15px;
    }
    
    .quiz-title {
        font-size: 1.1rem;
        margin-right: 50px;
    }
    
    .timer-container {
        position: absolute;
        left: auto;
        right: 15px;
        top: 15px;
        width: 40px;
        height: 40px;
    }
    
    .quiz-body {
        padding: 20px;
    }
    
    .question-text {
        font-size: 1.1rem;
    }
    
    .option {
        padding: 12px 15px;
    }
    
    .result-container {
        padding: 20px;
    }
    
    .result-icon {
        font-size: 60px;
    }
    
    .result-score {
        font-size: 2rem;
    }
    
    .stat-box {
        min-width: 120px;
        padding: 15px;
    }
    
    .stat-value {
        font-size: 1.5rem;
    }
}

@media (max-width: 480px) {
    .quiz-footer {
        flex-direction: column;
        gap: 10px;
    }
    
    .btn {
        width: 100%;
    }
    
    .buttons-container {
        flex-direction: column;
    }
    
    .stat-box {
        min-width: 100%;
    }
}

/* وضعية المراجعة */
.review-mode .option {
    cursor: default;
}

.review-mode .option input {
    display: none;
}

.review-mode .option-radio {
    display: none;
}

.review-navigation {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
}

.review-index {
    text-align: center;
    margin: 20px 0;
    font-weight: 700;
    color: var(--primary);
}











.toast.show {
    animation: slideIn 0.3s forwards;
}

@keyframes slideIn {
    from { bottom: -50px; opacity: 0; }
    to { bottom: 30px; opacity: 1; }
}

.fa-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}









/* إضافة هذه الأنماط إلى ملف CSS الخاص بك */
.previous-results {
    background-color: var(--card-bg);
    border-radius: 10px;
    padding: 20px;
    margin-top: 30px;
    border: 1px solid var(--border-color);
}

.section-title {
    font-size: 1.2rem;
    font-weight: bold;
    margin-bottom: 15px;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 10px;
}

.section-title i {
    font-size: 1.4rem;
}

.result-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px dashed var(--border-color);
}

.result-label {
    font-weight: bold;
    color: var(--text-muted);
}

.result-value {
    font-weight: bold;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-top: 20px;
}

.stat-item {
    background-color: var(--body-bg);
    padding: 10px;
    border-radius: 8px;
    text-align: center;
}

.stat-title {
    font-weight: bold;
    margin-bottom: 5px;
    color: var(--primary);
}

.no-previous-results {
    text-align: center;
    margin-top: 30px;
    color: var(--text-muted);
}






/* أنماط النتائج السابقة */
.previous-results-section {
    background-color: var(--card-bg);
    border-radius: 12px;
    padding: 20px;
    margin-top: 30px;
    border: 1px solid var(--border-color);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.section-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    color: var(--primary);
}

.section-header i {
    font-size: 1.4rem;
}

.section-header h3 {
    margin: 0;
    font-size: 1.3rem;
}

.previous-result-card {
    background-color: var(--body-bg);
    border-radius: 10px;
    padding: 15px;
}

.previous-result-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px dashed var(--border-color);
}

.previous-result-date {
    color: var(--text-muted);
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 5px;
}

.previous-result-score {
    font-weight: bold;
    color: var(--primary);
    font-size: 1.1rem;
}

.previous-stats-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.previous-stat-box {
    text-align: center;
    padding: 10px;
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
}

.previous-stat-value {
    font-weight: bold;
    font-size: 1.2rem;
    margin-bottom: 5px;
}

.previous-stat-label {
    color: var(--text-muted);
    font-size: 0.9rem;
}

.previous-difficulty-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
}

.previous-difficulty-level {
    text-align: center;
    padding: 8px;
    background-color: rgba(255, 255, 255, 0.05);
    border-radius: 6px;
}

.previous-level-title {
    font-weight: bold;
    display: block;
    margin-bottom: 3px;
}

.previous-level-title.easy {
    color: var(--easy);
}

.previous-level-title.medium {
    color: var(--medium);
}

.previous-level-title.hard {
    color: var(--hard);
}

.previous-level-stats {
    font-size: 0.9rem;
}

.no-previous-results, .error-loading-results {
    text-align: center;
    padding: 20px;
    color: var(--text-muted);
}

.no-previous-results i, .error-loading-results i {
    font-size: 2rem;
    margin-bottom: 10px;
    color: var(--primary);
}

.error-loading-results i {
    color: var(--danger);
}

/* تحسينات عامة للنتائج الحالية */
.current-results {
    margin-bottom: 30px;
}

.difficulty-stats {
    text-align: right;
    margin: 20px 0;
}

.difficulty-stats h3 {
    margin-bottom: 15px;
    color: var(--dark);
    font-size: 1.2rem;
}

.difficulty-level {
    margin-bottom: 15px;
}

.level-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
}

.level-title {
    font-weight: 600;
}

.progress-stats {
    height: 8px;
    background-color: var(--body-bg);
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
}

.progress-easy {
    background-color: var(--easy);
}

.progress-medium {
    background-color: var(--medium);
}

.progress-hard {
    background-color: var(--hard);
}









/* أنماط زر الحفظ */
#save-btn {
    margin-bottom: 10px;
    width: 100%;
}

.buttons-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 20px;
}

/* أنماط زر التحديث */
.refresh-button {
    position: fixed;
    bottom: 20px;
    left: 20px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: var(--primary);
    color: white;
    border: none;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    cursor: pointer;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    transition: all 0.3s ease;
}

.refresh-button:hover {
    background-color: var(--secondary);
    transform: rotate(360deg) scale(1.1);
}

.refresh-button:active {
    transform: rotate(720deg) scale(0.9);
}





        /* زر العودة */
        .back-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            color: var(--primary);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            z-index: 100;
            transition: var(--transition);
            text-decoration: none;
            font-size: 1.2rem;
        }

        .back-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
		

.buttons-container {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    flex-wrap: wrap;
    justify-content: center;
}

    </style>
</head>
<body>
    <div class="container">
        <!-- شاشة البداية -->
        <div class="start-screen" id="start-screen">
            <h1>علم الاحياء</h1>
            
            
            <div class="quiz-info">
                <div class="info-box">
                    <i class="fas fa-question-circle"></i>
                    <h3>عدد الأسئلة</h3>
                    <p id="total-questions">0</p>
                </div>
                <div class="info-box">
                    <i class="fas fa-clock"></i>
                    <h3>الوقت</h3>
                    <p id="total-time">0 دقيقة</p>
                </div>
                <div class="info-box">
                    <i class="fas fa-trophy"></i>
                    <h3>النقاط</h3>
                    <p id="total-points">0</p>
                </div>
            </div>
<div class="buttons-container">
    <button class="btn btn-primary" id="start-btn">
        <i class="fas fa-play"></i> بدء الاختبار
    </button>
    <a href="../../index.html" class="btn btn-outline" style="text-decoration: none;">
        <i class="fas fa-sign-out-alt"></i> العودة
    </a>
</div>

            <!-- زر التحديث -->
<button id="refresh-btn" class="refresh-button" title="تحديث الصفحة">
    <i class="fas fa-sync-alt"></i>
</button>

        </div>
        
        <!-- شاشة الكويز -->
        <div class="quiz-container" id="quiz-container">
            <div class="quiz-header">
                <div class="timer-container">
                    <svg class="timer-circle" viewBox="0 0 100 100">
                        <circle class="timer-background" cx="50" cy="50" r="45"></circle>
                        <circle class="timer-progress" cx="50" cy="50" r="45"></circle>
                    </svg>
                    <div class="timer-text" id="timer-text">30</div>
                </div>
                
                <div class="header-content">
                    <div class="quiz-title">كويز علم الاحياء</div>
                    <div class="question-progress" id="question-progress">سؤال 1 من 10</div>
                </div>
                
                <div class="progress-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
            </div>
            
            <div class="quiz-body" id="quiz-body">
                <!-- محتوى السؤال يضاف هنا ديناميكيًا -->
            </div>
        </div>
        
        <!-- شاشة النتائج -->
        <div class="result-container" id="result-container">
    <!-- النتائج الحالية -->
    <div class="current-results">
        <div class="result-icon">
            <i class="fas fa-trophy"></i>
        </div>
        <div class="result-score" id="result-score">0/0</div>
        <div class="result-message" id="result-message">ممتاز! لديك معرفة رائعة في الكيمياء</div>
        
        <div class="stats-container">
            <div class="stat-box">
                <div class="stat-value" id="correct-answers">0</div>
                <div class="stat-label">إجابات صحيحة</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="total-points-earned">0</div>
                <div class="stat-label">النقاط الكلية</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="time-taken">0</div>
                <div class="stat-label">الوقت المستغرق</div>
            </div>
        </div>
        
        <div class="difficulty-stats">
            <h3>تفصيل النتائج حسب الصعوبة</h3>
            
            <div class="difficulty-level">
                <div class="level-header">
                    <span class="level-title easy">الأسئلة السهلة</span>
                    <span class="level-stats" id="easy-stats">0/0</span>
                </div>
                <div class="progress-stats">
                    <div class="progress-fill progress-easy" id="easy-progress" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="difficulty-level">
                <div class="level-header">
                    <span class="level-title medium">الأسئلة المتوسطة</span>
                    <span class="level-stats" id="medium-stats">0/0</span>
                </div>
                <div class="progress-stats">
                    <div class="progress-fill progress-medium" id="medium-progress" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="difficulty-level">
                <div class="level-header">
                    <span class="level-title hard">الأسئلة الصعبة</span>
                    <span class="level-stats" id="hard-stats">0/0</span>
                </div>
                <div class="progress-stats">
                    <div class="progress-fill progress-hard" id="hard-progress" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- النتائج السابقة -->
    <div class="previous-results-section">
        <div class="section-header">
            <i class="fas fa-history"></i>
            <h3>نتائجك السابقة</h3>
        </div>
        <div id="previous-results-content">
            <!-- سيتم ملؤها ديناميكياً بالنتائج السابقة -->
        </div>
    </div>
    
    <div class="buttons-container">
        <button class="btn btn-primary" id="restart-btn">
            <i class="fas fa-redo"></i> إعادة الاختبار
        </button>
        <button class="btn btn-outline" id="review-btn">
            <i class="fas fa-search"></i> مراجعة الأخطاء
        </button>
        <button class="btn btn-outline" id="home-btn">
            <i class="fas fa-home"></i> العودة للرئيسية
        </button>
    </div>
        </div>
    </div>
    
    <!-- رسالة التحميل -->
    <div class="loading-container" id="loading-container">
        <div class="loading-spinner"></div>
        <div class="loading-text">جاري تحميل الأسئلة...</div>
    </div>
    
    <!-- رسالة تنبيه -->
    <div class="toast" id="toast" style="display: none;">
        <i class="fas fa-exclamation-circle"></i>
        <span id="toast-message">الرجاء اختيار إجابة قبل المتابعة</span>
    </div>
    
    <!-- تكبير الصور -->
    <div class="zoom-modal" id="zoom-modal">
        <div class="zoom-close" id="zoom-close">
            <i class="fas fa-times"></i>
        </div>
        <img class="zoom-content" id="zoom-content" src="" alt="صورة مكبرة">
    </div>
    



<script>








function getQuizPath() {
    try {
        // إذا كان المسار محدداً في ملف JSON
        if (questions[0]?.quiz_path) {
            return questions[0].quiz_path;
        }
        
        // تحديد المسار تلقائياً من عنوان URL
        const path = window.location.pathname;
        const parts = path.split('/')
            .filter(p => p && !p.includes('.html') && !p.includes('.json'));
        
        // إزالة أجزاء غير مرغوبة (مثل 'quiz' أو 'pages')
        const filtered = parts.filter(p => !['quiz', 'pages', 'tests'].includes(p));
        
        if (filtered.length > 0) {
            return filtered.join('/');
        }
        
        // إذا لم يتم تحديد المسار، نستخدم قيمة افتراضية
        return 'default/path';
    } catch (error) {
        console.error('Error determining quiz path:', error);
        return 'unknown/path';
    }
}


// الحصول على الاسم الحقيقي
function getRealName() {
    // حاول الحصول من localStorage أولاً
    let realName = localStorage.getItem('quiz_real_name') || '';
    
    // إذا لم يوجد، حاول الحصول من AndroidBridge
    if (!realName && typeof AndroidBridge !== 'undefined') {
        realName = AndroidBridge.getRealName() || '';
        if (realName) {
            localStorage.setItem('quiz_real_name', realName);
        }
    }
    
    return realName;
}

// طلب إدخال الاسم إذا لم يكن موجوداً
async function requestRealName() {
    const { value: realName } = await Swal.fire({
        title: 'أدخل اسمك الحقيقي',
        input: 'text',
        inputLabel: 'الاسم الكامل (بالعربية أو الإنجليزية)',
        inputPlaceholder: 'أدخل اسمك هنا...',
        allowOutsideClick: false,
        inputValidator: (value) => {
            if (!value) {
                return 'يجب إدخال اسم!';
            }
        }
    });
    
    if (realName) {
        localStorage.setItem('quiz_real_name', realName);
        return realName;
    }
    
    return null;
}



    // بيانات الاختبار
    let questions = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let totalPoints = 0;
    let userAnswers = [];
    let timer;
    let timeLeft = 0;
    let quizStartTime;
    let quizEndTime;
    let questionTimes = []; // تخزين الأوقات المتبقية لكل سؤال
    
    // إحصائيات حسب مستوى الصعوبة
    let stats = {
        easy: { total: 0, correct: 0, wrong: 0 },
        medium: { total: 0, correct: 0, wrong: 0 },
        hard: { total: 0, correct: 0, wrong: 0 }
    };
    
    // عناصر DOM
    const startScreen = document.getElementById('start-screen');
    const quizContainer = document.getElementById('quiz-container');
    const resultContainer = document.getElementById('result-container');
    const quizBody = document.getElementById('quiz-body');
    const progressBar = document.getElementById('progress-bar');
    const questionProgress = document.getElementById('question-progress');
    const timerText = document.getElementById('timer-text');
    const timerProgress = document.querySelector('.timer-progress');
    const totalQuestionsEl = document.getElementById('total-questions');
    const totalTimeEl = document.getElementById('total-time');
    const totalPointsEl = document.getElementById('total-points');
    const resultScore = document.getElementById('result-score');
    const resultMessage = document.getElementById('result-message');
    const correctAnswersEl = document.getElementById('correct-answers');
    const totalPointsEarned = document.getElementById('total-points-earned');
    const timeTakenEl = document.getElementById('time-taken');
    const easyStatsEl = document.getElementById('easy-stats');
    const mediumStatsEl = document.getElementById('medium-stats');
    const hardStatsEl = document.getElementById('hard-stats');
    const easyProgress = document.getElementById('easy-progress');
    const mediumProgress = document.getElementById('medium-progress');
    const hardProgress = document.getElementById('hard-progress');
    const startBtn = document.getElementById('start-btn');
    const restartBtn = document.getElementById('restart-btn');
    const homeBtn = document.getElementById('home-btn');
    const loadingContainer = document.getElementById('loading-container');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');
    const zoomModal = document.getElementById('zoom-modal');
    const zoomContent = document.getElementById('zoom-content');
    const zoomClose = document.getElementById('zoom-close');


    document.getElementById('review-btn').addEventListener('click', reviewMistakes);
    
    // تحميل الأسئلة من ملف JSON
    function loadQuestions() {
        loadingContainer.style.display = 'flex';
        
        fetch('q1.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error('فشل تحميل الأسئلة');
                }
                return response.json();
            })
            .then(data => {
                questions = data;
                questionTimes = new Array(questions.length).fill(null); // تهيئة مصفوفة الأوقات
                calculateInitialStats();
                setupStartScreen();
                setTimeout(() => {
                    loadingContainer.style.display = 'none';
                }, 500);
            })
            .catch(error => {
                console.error('حدث خطأ في تحميل الأسئلة:', error);
                loadingContainer.innerHTML = `
                    <div style="text-align: center;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--danger); margin-bottom: 20px;"></i>
                        <div class="loading-text">حدث خطأ في تحميل الأسئلة</div>
                        <button class="btn btn-primary" onclick="window.location.reload()" style="margin-top: 20px;">
                            <i class="fas fa-sync-alt"></i> إعادة المحاولة
                        </button>
                    </div>
                `;
            });
    }
    
    // حساب الإحصائيات الأولية للأسئلة
    function calculateInitialStats() {
        stats = {
            easy: { total: 0, correct: 0, wrong: 0 },
            medium: { total: 0, correct: 0, wrong: 0 },
            hard: { total: 0, correct: 0, wrong: 0 }
        };
        
        questions.forEach(question => {
            if (question.level === 'easy') {
                stats.easy.total++;
            } else if (question.level === 'medium') {
                stats.medium.total++;
            } else if (question.level === 'hard') {
                stats.hard.total++;
            }
        });
    }
    
    // إعداد واجهة البداية
    function setupStartScreen() {
    totalQuestionsEl.textContent = questions.length;
    
    const totalSeconds = questions.reduce((total, question) => {
        const timeStr = question.time || '30s';
        const seconds = parseInt(timeStr) || 30;
        return total + seconds;
    }, 0);
    
    const totalMinutes = Math.ceil(totalSeconds / 60);
    totalTimeEl.textContent = `${totalMinutes} دقيقة`;
    
    // تعديل هنا لجعل جميع الأسئلة تساوي 1 نقطة
    totalPoints = questions.length; // لأن كل سؤال = 1 نقطة
    
    totalPointsEl.textContent = totalPoints;
}
    
    // بدء الاختبار
    function startQuiz() {
        startScreen.style.display = 'none';
        quizContainer.style.display = 'block';
        userAnswers = Array(questions.length).fill(null);
        questionTimes = new Array(questions.length).fill(null); // إعادة تهيئة الأوقات
        score = 0;
        currentQuestionIndex = 0;
        quizStartTime = new Date();
        displayQuestion();
    }
    
    // عرض السؤال الحالي
    function displayQuestion() {
        const question = questions[currentQuestionIndex];
        const timeStr = question.time || '30s';
        
        // إذا كان الوقت لم يتم تخزينه مسبقاً (أول مرة يصل لهذا السؤال)
        if (questionTimes[currentQuestionIndex] === null) {
            questionTimes[currentQuestionIndex] = parseInt(timeStr) || 30;
        }
        
        timeLeft = questionTimes[currentQuestionIndex];
        
        questionProgress.textContent = `سؤال ${currentQuestionIndex + 1} من ${questions.length}`;
        progressBar.style.width = `${((currentQuestionIndex + 1) / questions.length) * 100}%`;
        
        let questionHTML = `
            <div class="question-header">
                <div class="question-tag ${getLevelClass(question.level)}">
                    ${getLevelText(question.level)}
                </div>
                <div class="question-points">
                    ${getQuestionPoints(question.level)} نقطة
                </div>
            </div>
            
            <div class="question-text">${question.question}</div>
        `;
        
        if (question.image) {
            questionHTML += `
                <div class="question-image" onclick="openZoomModal('${question.image}')">
                    <img src="${question.image}" alt="صورة السؤال">
                </div>
            `;
        }
        
        questionHTML += `<div class="options-container" id="options-container">`;
        
        question.options.forEach((option, index) => {
            const isAnswered = userAnswers[currentQuestionIndex] !== null;
            const isSelected = userAnswers[currentQuestionIndex] === index;
            const isCorrect = index === question.correctAnswer;
            
            questionHTML += `
                <label class="option ${isAnswered ? 'disabled' : ''} 
                       ${isAnswered && isSelected ? (isCorrect ? 'correct' : 'incorrect') : ''}
                       ${isAnswered && isCorrect ? 'correct' : ''}">
                    <input type="radio" name="question" value="${index}" 
                           ${isAnswered ? 'disabled' : ''} 
                           ${isSelected ? 'checked' : ''}>
                    <span class="option-radio"></span>
                    <span class="option-text">${option}</span>
                </label>
            `;
        });
        
        questionHTML += `</div>`;
        
        if (userAnswers[currentQuestionIndex] !== null) {
            questionHTML += `
                <div class="explanation" style="display: block;">
                    <div class="explanation-title">
                        <i class="fas fa-info-circle"></i>
                        الشرح
                    </div>
                    <div class="explanation-text">${question.explanation}</div>
                </div>
            `;
        } else {
            questionHTML += `
                <div class="explanation">
                    <div class="explanation-title">
                        <i class="fas fa-info-circle"></i>
                        الشرح
                    </div>
                    <div class="explanation-text">${question.explanation}</div>
                </div>
            `;
        }
        
        questionHTML += `
            <div class="quiz-footer">
                <button class="btn btn-outline" onclick="previousQuestion()" ${currentQuestionIndex === 0 ? 'disabled' : ''}>
                    <i class="fas fa-arrow-right"></i> السابق
                </button>
                <button class="btn btn-primary" onclick="nextQuestion()" id="next-btn">
                    ${currentQuestionIndex === questions.length - 1 ? 'إنهاء الاختبار' : 'التالي <i class="fas fa-arrow-left"></i>'}
                </button>
            </div>
        `;
        
        quizBody.innerHTML = questionHTML;
        
        // لا تبدأ المؤقت إذا كان السؤال قد تمت الإجابة عليه
        if (userAnswers[currentQuestionIndex] === null) {
            startTimer();
        } else {
            // إذا كان السؤال قد تمت الإجابة عليه، قم بتعطيل الخيارات وإظهار الشرح
            const options = document.querySelectorAll('.option');
            options.forEach(option => {
                option.classList.add('disabled');
                option.querySelector('input').disabled = true;
            });
            
            document.querySelector('.explanation').style.display = 'block';
        }
    }
    
    // بدء المؤقت للسؤال الحالي
    function startTimer() {
        updateTimerDisplay();
        
        const circumference = 2 * Math.PI * 45;
        timerProgress.style.strokeDasharray = circumference;
        
        if (timer) clearInterval(timer);
        
        timer = setInterval(() => {
            timeLeft--;
            questionTimes[currentQuestionIndex] = timeLeft; // تحديث الوقت المتبقي للسؤال الحالي
            updateTimerDisplay();
            
            if (timeLeft <= 0) {
                clearInterval(timer);
                handleTimeOut();
            }
        }, 1000);
    }
    
    // تحديث عرض المؤقت
    function updateTimerDisplay() {
        timerText.textContent = timeLeft;
        
        const timeStr = questions[currentQuestionIndex].time || '30s';
        const totalTime = parseInt(timeStr) || 30;
        const percentage = (timeLeft / totalTime) * 100;
        
        const circumference = 2 * Math.PI * 45;
        const offset = circumference - (percentage / 100) * circumference;
        timerProgress.style.strokeDashoffset = offset;
        
        if (percentage < 20) {
            timerProgress.style.stroke = 'var(--danger)';
            timerText.style.color = 'var(--danger)';
        } else if (percentage < 50) {
            timerProgress.style.stroke = 'var(--warning)';
            timerText.style.color = 'var(--warning)';
        } else {
            timerProgress.style.stroke = 'white';
            timerText.style.color = 'white';
        }
    }
    
    // انتهاء الوقت للسؤال الحالي
    function handleTimeOut() {
    const options = document.querySelectorAll('.option');
    options.forEach(option => {
        option.classList.add('disabled');
        option.querySelector('input').disabled = true;
    });
    
    document.querySelector('.explanation').style.display = 'block';
    
    // تسجيل إجابة خاطئة إذا لم يتم الإجابة
    if (userAnswers[currentQuestionIndex] === null) {
        userAnswers[currentQuestionIndex] = -1; // -1 يعني انتهى الوقت
        
        // تحديث الإحصائيات حسب مستوى الصعوبة
        const question = questions[currentQuestionIndex];
        if (question.level === 'easy') {
            stats.easy.wrong++;
        } else if (question.level === 'medium') {
            stats.medium.wrong++;
        } else if (question.level === 'hard') {
            stats.hard.wrong++;
        }
    }
    
    // تم إزالة الانتقال التلقائي هنا أيضاً
}
    
    // الانتقال إلى السؤال التالي
    function nextQuestion() {
        const selectedOption = document.querySelector('input[name="question"]:checked');
        
        if (selectedOption || userAnswers[currentQuestionIndex] !== null) {
            if (userAnswers[currentQuestionIndex] === null) {
                const selectedValue = parseInt(selectedOption.value);
                userAnswers[currentQuestionIndex] = selectedValue;
                
                if (selectedValue === questions[currentQuestionIndex].correctAnswer) {
                    score += getQuestionPoints(questions[currentQuestionIndex].level);
                    
                    if (questions[currentQuestionIndex].level === 'easy') {
                        stats.easy.correct++;
                    } else if (questions[currentQuestionIndex].level === 'medium') {
                        stats.medium.correct++;
                    } else if (questions[currentQuestionIndex].level === 'hard') {
                        stats.hard.correct++;
                    }
                } else {
                    if (questions[currentQuestionIndex].level === 'easy') {
                        stats.easy.wrong++;
                    } else if (questions[currentQuestionIndex].level === 'medium') {
                        stats.medium.wrong++;
                    } else if (questions[currentQuestionIndex].level === 'hard') {
                        stats.hard.wrong++;
                    }
                }
                
                showFeedback();
            } else {
                goToNextQuestion();
            }
        } else {
            showToast("الرجاء اختيار إجابة قبل المتابعة");
        }
    }
    
    // عرض التغذية الراجعة للإجابة
    // في دالة showFeedback()، قم بتعديلها لتصبح كالتالي:
function showFeedback() {
    const options = document.querySelectorAll('.option');
    const question = questions[currentQuestionIndex];
    
    options.forEach((option, index) => {
        const input = option.querySelector('input');
        const isSelected = parseInt(input.value) === userAnswers[currentQuestionIndex];
        const isCorrect = index === question.correctAnswer;
        
        if (isCorrect) {
            option.classList.add('correct');
        } else if (isSelected && !isCorrect) {
            option.classList.add('incorrect');
        }
        
        option.classList.add('disabled');
        input.disabled = true;
    });
    
    document.querySelector('.explanation').style.display = 'block';
    
    // تم إزالة setTimeout الذي كان ينقل تلقائياً للسؤال التالي
    // والآن المستخدم يحتاج للنقر على "التالي" للانتقال
}
    
    // الانتقال الفعلي للسؤال التالي
    function goToNextQuestion() {
        if (timer) clearInterval(timer);
        
        if (currentQuestionIndex < questions.length - 1) {
            currentQuestionIndex++;
            displayQuestion();
        } else {
            showResults();
        }
    }
    
    // العودة إلى السؤال السابق
    function previousQuestion() {
        if (timer) clearInterval(timer);
        
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            displayQuestion();
        }
    }
    















    // عرض النتائج النهائية
  // عرض النتائج النهائية
// عرض النتائج النهائية
// عرض النتائج النهائية
async function showResults() {
    quizContainer.style.display = 'none';
    resultContainer.style.display = 'block';
    quizEndTime = new Date();
    
    const timeDiff = (quizEndTime - quizStartTime) / 1000;
    const minutes = Math.floor(timeDiff / 60);
    const seconds = Math.floor(timeDiff % 60);
    timeTakenEl.textContent = `${minutes} د ${seconds} ث`;
    
    resultScore.textContent = `${score} / ${totalPoints}`;
    
    const percentage = (score / totalPoints) * 100;
    if (percentage >= 90) {
        resultMessage.textContent = "ممتاز! لديك معرفة رائعة في علم الاحياء";
    } else if (percentage >= 70) {
        resultMessage.textContent = "جيد جداً! لديك فهم قوي للموضوع";
    } else if (percentage >= 50) {
        resultMessage.textContent = "مقبول! يمكنك تحسين معرفتك بالمزيد من الدراسة";
    } else {
        resultMessage.textContent = "يحتاج إلى تحسين! ننصحك بمراجعة المادة مرة أخرى";
    }
    
    const correctAnswers = userAnswers.filter((ans, i) => ans === questions[i].correctAnswer).length;
    const totalAnswered = userAnswers.filter(ans => ans !== null).length;
    
    correctAnswersEl.textContent = `${correctAnswers} / ${totalAnswered}`;
    totalPointsEarned.textContent = score;
    
    updateStatsDisplay();
    
    // إرسال النتائج تلقائياً وعرض النتائج السابقة
    const saveStatus = await sendResultsAutomatically();
    await displayPreviousResults();
    
    // عرض حالة الاختبار المسبق
    showSubmissionStatus(saveStatus);
}





// عرض حالة الاختبار المسبق
function showSubmissionStatus(saveStatus) {
    const statusContainer = document.createElement('div');
    statusContainer.className = 'submission-status';
    
    if (saveStatus === 'already_submitted') {
        statusContainer.innerHTML = `
            <div class="status-banner warning">
                <i class="fas fa-exclamation-circle"></i>
                <div>
                    <strong>تم تقديم الاختبار مسبقاً</strong>
                    <p>هذه محاولة تدريبية فقط،</p>
                </div>
            </div>
        `;
    } else if (saveStatus === 'saved') {
        statusContainer.innerHTML = `
            <div class="status-banner success">
                <i class="fas fa-check-circle"></i>
                <div>
                    <strong>تم حفظ نتائجك بنجاح</strong>
                    <p>يمكنك مراجعة النتائج السابقة أدناه</p>
                </div>
            </div>
        `;
    } else if (saveStatus === 'error') {
        statusContainer.innerHTML = `
            <div class="status-banner error">
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                    <strong>حدث خطأ في حفظ النتائج</strong>
                    <p>الرجاء المحاولة لاحقاً</p>
                </div>
            </div>
        `;
    }
    
    // إضافة البانر في أعلى واجهة النتائج
    document.querySelector('.result-container').prepend(statusContainer);
}

// عرض النتائج السابقة من قاعدة البيانات
async function displayPreviousResults() {
    const realName = getRealName();
    if (!realName) return;

    try {
        const response = await fetch('https://mhooad.ct.ws/get_results.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json; charset=UTF-8',
            },
            body: JSON.stringify({ student_name: realName })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            const previousResults = data.results;
            
            // إنشاء عنصر لعرض النتائج السابقة
            const previousResultsDiv = document.createElement('div');
            previousResultsDiv.className = 'previous-results';
            previousResultsDiv.innerHTML = `
                <div class="section-title">
                    <i class="fas fa-history"></i>
                    نتائجك السابقة
                </div>
                <div class="result-row">
                    <div class="result-label">آخر نتيجة:</div>
                    <div class="result-value">
                        ${previousResults.score}/${previousResults.total_points} نقطة
                    </div>
                </div>
                <div class="result-row">
                    <div class="result-label">الإجابات الصحيحة:</div>
                    <div class="result-value">
                        ${previousResults.correct_answers}/${previousResults.total_questions}
                    </div>
                </div>
                <div class="result-row">
                    <div class="result-label">تاريخ الاختبار:</div>
                    <div class="result-value">
                        ${new Date(previousResults.created_at).toLocaleDateString('ar-EG')}
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-title">سهل</div>
                        <div class="stat-value">${previousResults.easy_stats}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-title">متوسط</div>
                        <div class="stat-value">${previousResults.medium_stats}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-title">صعب</div>
                        <div class="stat-value">${previousResults.hard_stats}</div>
                    </div>
                </div>
            `;
            
            // إضافة النتائج السابقة إلى واجهة النتائج
            document.querySelector('.results-container').appendChild(previousResultsDiv);
            
        } else if (data.status === 'empty') {
            // لا توجد نتائج سابقة
            const noResultsDiv = document.createElement('div');
            noResultsDiv.className = 'no-previous-results';
            noResultsDiv.innerHTML = `
                <div class="section-title">
                    <i class="fas fa-info-circle"></i>
                    هذه هي أول محاولة لك
                </div>
            `;
            document.querySelector('.results-container').appendChild(noResultsDiv);
        }
    } catch (error) {
        console.error('Error fetching previous results:', error);
    }
}















    // تحديث عرض الإحصائيات
    function updateStatsDisplay() {
        easyStatsEl.textContent = `${stats.easy.correct} / ${stats.easy.total} (${stats.easy.wrong} خطأ)`;
        mediumStatsEl.textContent = `${stats.medium.correct} / ${stats.medium.total} (${stats.medium.wrong} خطأ)`;
        hardStatsEl.textContent = `${stats.hard.correct} / ${stats.hard.total} (${stats.hard.wrong} خطأ)`;
        
        easyProgress.style.width = stats.easy.total > 0 ? `${(stats.easy.correct / stats.easy.total) * 100}%` : '0%';
        mediumProgress.style.width = stats.medium.total > 0 ? `${(stats.medium.correct / stats.medium.total) * 100}%` : '0%';
        hardProgress.style.width = stats.hard.total > 0 ? `${(stats.hard.correct / stats.hard.total) * 100}%` : '0%';
    }
    
    // إعادة بدء الاختبار
    function restartQuiz() {
        resultContainer.style.display = 'none';
        currentQuestionIndex = 0;
        score = 0;
        userAnswers = Array(questions.length).fill(null);
        questionTimes = new Array(questions.length).fill(null); // إعادة تعيين الأوقات
        
        // إعادة تعيين الإحصائيات
        stats.easy.correct = 0;
        stats.easy.wrong = 0;
        stats.medium.correct = 0;
        stats.medium.wrong = 0;
        stats.hard.correct = 0;
        stats.hard.wrong = 0;
        
        startQuiz();
    }
    
    // العودة إلى شاشة البداية
function goToHome() {
    // الانتقال إلى الصفحة الرئيسية index.html
    window.location.href = "../../index.html";
}
    
    // عرض رسالة Toast
    function showToast(message) {
        toastMessage.textContent = message;
        toast.style.display = 'flex';
        
        setTimeout(() => {
            toast.style.display = 'none';
        }, 3000);
    }
    
    // فتح صورة مكبرة
    function openZoomModal(imgSrc) {
        zoomContent.src = imgSrc;
        zoomModal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
    
    // إغلاق صورة مكبرة
    function closeZoomModal() {
        zoomModal.classList.remove('active');
        document.body.style.overflow = 'auto';
    }
    
    // مساعدات للحصول على نص ومظهر مستوى الصعوبة
    function getLevelText(level) {
        switch(level) {
            case 'easy': return 'سهل';
            case 'medium': return 'متوسط';
            case 'hard': return 'صعب';
            default: return 'غير محدد';
        }
    }
    
    function getLevelClass(level) {
        switch(level) {
            case 'easy': return 'tag-easy';
            case 'medium': return 'tag-medium';
            case 'hard': return 'tag-hard';
            default: return '';
        }
    }
    
function getQuestionPoints(level) {
    return 1; // جميع الأسئلة تعطي 1 نقطة بغض النظر عن مستوى الصعوبة
}
    
    // أحداث DOM
    startBtn.addEventListener('click', startQuiz);
    restartBtn.addEventListener('click', restartQuiz);
    homeBtn.addEventListener('click', goToHome);
    zoomClose.addEventListener('click', closeZoomModal);
    
    // تحميل الأسئلة عند بدء الصفحة
    window.addEventListener('DOMContentLoaded', loadQuestions);

// مراجعة الأخطاء
function reviewMistakes() {
    resultContainer.style.display = 'none';
    quizContainer.style.display = 'block';
    quizContainer.classList.add('review-mode');
    
    // تصفية الأسئلة التي بها أخطاء فقط
    const wrongQuestions = [];
    userAnswers.forEach((answer, index) => {
        if (answer !== questions[index].correctAnswer && answer !== null) {
            wrongQuestions.push(index);
        }
    });
    
    if (wrongQuestions.length === 0) {
        showToast("لا توجد أخطاء لمراجعتها!");
        quizContainer.style.display = 'none';
        resultContainer.style.display = 'block';
        quizContainer.classList.remove('review-mode');
        return;
    }
    
    currentQuestionIndex = 0;
    displayReviewQuestion(wrongQuestions);
}

// عرض سؤال المراجعة
function displayReviewQuestion(wrongQuestions) {
    const questionIndex = wrongQuestions[currentQuestionIndex];
    const question = questions[questionIndex];
    
    questionProgress.textContent = `مراجعة ${currentQuestionIndex + 1} من ${wrongQuestions.length}`;
    progressBar.style.width = `${((currentQuestionIndex + 1) / wrongQuestions.length) * 100}%`;
    
    let questionHTML = `
        <div class="question-header">
            <div class="question-tag ${getLevelClass(question.level)}">
                ${getLevelText(question.level)}
            </div>
            <div class="question-points">
                ${getQuestionPoints(question.level)} نقطة
            </div>
        </div>
        
        <div class="question-text">${question.question}</div>
    `;
    
    if (question.image) {
        questionHTML += `
            <div class="question-image" onclick="openZoomModal('${question.image}')">
                <img src="${question.image}" alt="صورة السؤال">
            </div>
        `;
    }
    
    questionHTML += `<div class="options-container" id="options-container">`;
    
    question.options.forEach((option, index) => {
        const isSelected = userAnswers[questionIndex] === index;
        const isCorrect = index === question.correctAnswer;
        
        questionHTML += `
            <div class="option ${isSelected ? (isCorrect ? 'correct' : 'incorrect') : ''} 
                   ${isCorrect ? 'correct' : ''}">
                <span class="option-text">${option}</span>
            </div>
        `;
    });
    
    questionHTML += `</div>`;
    
    questionHTML += `
        <div class="explanation" style="display: block;">
            <div class="explanation-title">
                <i class="fas fa-info-circle"></i>
                الشرح
            </div>
            <div class="explanation-text">${question.explanation}</div>
        </div>
        
        <div class="review-index">
            سؤال ${questionIndex + 1} من الأسئلة الأصلية
        </div>
        
        <div class="quiz-footer">
            <button class="btn btn-outline" onclick="previousReviewQuestion(${JSON.stringify(wrongQuestions)})" ${currentQuestionIndex === 0 ? 'disabled' : ''}>
                <i class="fas fa-arrow-right"></i> السابق
            </button>
            <button class="btn btn-primary" onclick="nextReviewQuestion(${JSON.stringify(wrongQuestions)})" id="next-btn">
                ${currentQuestionIndex === wrongQuestions.length - 1 ? 'إنهاء المراجعة' : 'التالي <i class="fas fa-arrow-left"></i>'}
            </button>
        </div>
    `;
    
    quizBody.innerHTML = questionHTML;
}

// الانتقال إلى سؤال المراجعة التالي
function nextReviewQuestion(wrongQuestions) {
    if (currentQuestionIndex < wrongQuestions.length - 1) {
        currentQuestionIndex++;
        displayReviewQuestion(wrongQuestions);
    } else {
        endReview();
    }
}

// العودة إلى سؤال المراجعة السابق
function previousReviewQuestion(wrongQuestions) {
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        displayReviewQuestion(wrongQuestions);
    }
}

// إنهاء المراجعة
function endReview() {
    quizContainer.style.display = 'none';
    resultContainer.style.display = 'block';
    quizContainer.classList.remove('review-mode');
}


















async function sendResultsToDatabase() {
    // استخدام SweetAlert2 لمربع حوار أجمل
    const { value: studentName } = await Swal.fire({
        title: 'أدخل اسمك',
        input: 'text',
        inputLabel: 'الاسم الكامل (بالعربية أو الإنجليزية)',
        inputPlaceholder: 'أدخل اسمك هنا...',
        showCancelButton: true,
        inputValidator: (value) => {
            if (!value) {
                return 'يجب إدخال اسم!';
            }
        }
    });
    
    if (!studentName) {
        showToast("لم يتم حفظ النتائج، يرجى إدخال اسم صحيح");
        return;
    }
    
    const timeDiff = (quizEndTime - quizStartTime) / 1000;
    const timeSpent = `${Math.floor(timeDiff / 60)}:${Math.floor(timeDiff % 60).toString().padStart(2, '0')}`;
    const totalAnswered = userAnswers.filter(ans => ans !== null).length;
    const correctAnswers = userAnswers.filter((ans, i) => ans === questions[i].correctAnswer).length;
    
    // بيانات النتائج المراد إرسالها
    const resultData = {
        student_name: studentName,
        score: score,
        total_points: totalPoints,
        time_spent: timeSpent,
        correct_answers: correctAnswers,
        total_questions: questions.length,
        easy_stats: `${stats.easy.correct}/${stats.easy.total}`,
        medium_stats: `${stats.medium.correct}/${stats.medium.total}`,
        hard_stats: `${stats.hard.correct}/${stats.hard.total}`
    };
    
    try {
        // عرض تحميل
        Swal.fire({
            title: 'جاري التحقق من حالة الطالب',
            html: 'الرجاء الانتظار...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        // التحقق أولاً إذا كان الطالب قد قدم الاختبار مسبقاً
        const hasSubmitted = await checkSubmissionStatus(studentName);
        
        if (hasSubmitted) {
            Swal.fire({
                icon: 'info',
                title: 'تم تقديم الاختبار مسبقاً',
                text: 'يمكنك إعادة الاختبار ولكن النتائج لن يتم حفظها في قاعدة البيانات',
                confirmButtonText: 'حسناً'
            });
            return;
        }
        
        // إذا لم يقدم الاختبار مسبقاً، نستمر في الحفظ
        Swal.fire({
            title: 'جاري حفظ النتائج',
            html: 'الرجاء الانتظار...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        // أولاً: تسجيل محاولة الاختبار
        const attemptResult = await submitQuizAttempt(studentName, score, totalPoints);
        
        if (!attemptResult.success) {
            throw new Error(attemptResult.message);
        }
        
        // ثانياً: حفظ النتائج التفصيلية
        const response = await fetch('https://mhooad.ct.ws/submit_results.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json; charset=UTF-8',
            },
            body: JSON.stringify(resultData)
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            Swal.fire({
                icon: 'success',
                title: 'تم حفظ نتائجك بنجاح!',
                text: data.message,
                confirmButtonText: 'حسناً'
            });
        } else {
            throw new Error(data.message || 'خطأ غير معروف');
        }
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: 'فشل في الحفظ',
            text: error.message,
            confirmButtonText: 'حسناً'
        });
        console.error('Error:', error);
    }
}







// بدء الاختبار
// بدء الاختبار
async function startQuiz() {
    // الحصول على الاسم الحقيقي
    let realName = getRealName();
    
    // إذا لم يكن الاسم موجوداً، نطلبه من المستخدم
    if (!realName) {
        realName = await requestRealName();
        if (!realName) {
            showToast("يجب إدخال اسم لبدء الاختبار");
            return;
        }
    }
    
    // بدء الاختبار
    startScreen.style.display = 'none';
    quizContainer.style.display = 'block';
    userAnswers = Array(questions.length).fill(null);
    questionTimes = new Array(questions.length).fill(null);
    score = 0;
    currentQuestionIndex = 0;
    quizStartTime = new Date();
    displayQuestion();
}






// التحقق من حالة تقديم الاختبار
// التحقق من حالة تقديم الاختبار
// التحقق من حالة تقديم الاختبار (بدقة أكبر)
async function checkSubmissionStatus(studentName) {
    try {
        const response = await fetch('https://mhooad.ct.ws/check_submission.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json; charset=UTF-8',
            },
            body: JSON.stringify({ student_name: studentName })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            return data.has_submitted;
        } else {
            console.error('Error checking submission:', data.message);
            return false;
        }
    } catch (error) {
        console.error('Error checking submission:', error);
        return false;
    }
}

// تسجيل محاولة الاختبار
// تسجيل محاولة الاختبار
async function submitQuizAttempt(studentName, score, totalPoints) {
    try {
        const response = await fetch('https://mhooad.ct.ws/submit_quiz.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json; charset=UTF-8',
            },
            body: JSON.stringify({
                student_name: studentName,
                score: score,
                total_points: totalPoints
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            return { success: true, message: data.message };
        } else {
            return { success: false, message: data.message };
        }
    } catch (error) {
        return { success: false, message: error.message };
    }
}









// إرسال النتائج تلقائياً
// إرسال النتائج تلقائياً
// إرسال النتائج تلقائياً (مع ضمان عدم التكرار)
// إرسال النتائج تلقائياً (مع إرجاع حالة الحفظ)
async function sendResultsAutomatically() {
    let realName = getRealName();
    
    if (!realName) {
        realName = await requestRealName();
        if (!realName) {
            showToast("يجب إدخال اسم لحفظ النتائج");
            return 'error';
        }
    }
    
    const quizPath = getQuizPath();
    if (!quizPath) {
        console.error('تعذر تحديد مسار الكويز');
        return 'error';
    }

    const timeDiff = (quizEndTime - quizStartTime) / 1000;
    const timeSpent = `${Math.floor(timeDiff / 60)}:${Math.floor(timeDiff % 60).toString().padStart(2, '0')}`;
    const correctAnswers = userAnswers.filter((ans, i) => ans === questions[i].correctAnswer).length;
    
    const resultData = {
        student_name: realName,
        score: score,
        total_points: totalPoints,
        quiz_path: quizPath,
        time_spent: timeSpent,
        correct_answers: correctAnswers,
        total_questions: questions.length,
        easy_stats: `${stats.easy.correct}/${stats.easy.total}`,
        medium_stats: `${stats.medium.correct}/${stats.medium.total}`,
        hard_stats: `${stats.hard.correct}/${stats.hard.total}`
    };
    
    try {
        // التحقق من حالة التقديم مع المسار الجديد
        const checkResponse = await fetch('https://mhooad.ct.ws/check_submission.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json; charset=UTF-8',
            },
            body: JSON.stringify({
                student_name: realName,
                quiz_path: quizPath
            })
        });
        
        const checkData = await checkResponse.json();
        
        if (checkData.status === 'success' && checkData.has_submitted) {
            return 'already_submitted';
        }

        // تسجيل محاولة الاختبار
        const attemptResponse = await fetch('https://mhooad.ct.ws/submit_quiz.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json; charset=UTF-8',
            },
            body: JSON.stringify({
                student_name: realName,
                score: score,
                total_points: totalPoints,
                quiz_path: quizPath
            })
        });
        
        const attemptData = await attemptResponse.json();
        
        if (attemptData.status !== 'success') {
            throw new Error(attemptData.message || 'فشل في تسجيل المحاولة');
        }

        // حفظ النتائج التفصيلية
        const resultsResponse = await fetch('https://mhooad.ct.ws/submit_results.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json; charset=UTF-8',
            },
            body: JSON.stringify(resultData)
        });
        
        const resultsData = await resultsResponse.json();
        
        if (resultsData.status === 'success') {
            return 'saved';
        } else {
            throw new Error(resultsData.message || 'فشل في حفظ النتائج');
        }
    } catch (error) {
        console.error('حدث خطأ أثناء الحفظ:', error);
        showToast("حدث خطأ أثناء حفظ النتائج، الرجاء المحاولة لاحقاً");
        return 'error';
    }
}




// عرض النتائج السابقة من قاعدة البيانات
// عرض النتائج السابقة من قاعدة البيانات
// عرض النتائج السابقة من قاعدة البيانات
async function displayPreviousResults() {
    const realName = getRealName();
    if (!realName) return;

    try {
        const response = await fetch('https://mhooad.ct.ws/get_results.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json; charset=UTF-8',
            },
            body: JSON.stringify({ student_name: realName })
        });
        
        const data = await response.json();
        const previousResultsContent = document.getElementById('previous-results-content');
        
        if (data.status === 'success') {
            const previousResults = data.results;
            const date = new Date(previousResults.created_at);
            const formattedDate = date.toLocaleDateString('ar-EG', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            previousResultsContent.innerHTML = `
                <div class="previous-result-card">
                    <div class="previous-result-header">
                        <span class="previous-result-date">
                            <i class="far fa-calendar-alt"></i> ${formattedDate}
                        </span>
                        <span class="previous-result-score">
                            ${previousResults.score}/${previousResults.total_points} نقطة
                        </span>
                    </div>
                    
                    <div class="previous-stats-container">
                        <div class="previous-stat-box">
                            <div class="previous-stat-value">${previousResults.correct_answers}/${previousResults.total_questions}</div>
                            <div class="previous-stat-label">إجابات صحيحة</div>
                        </div>
                        
                        <div class="previous-difficulty-stats">
                            <div class="previous-difficulty-level">
                                <span class="previous-level-title easy">سهل</span>
                                <span class="previous-level-stats">${previousResults.easy_stats}</span>
                            </div>
                            <div class="previous-difficulty-level">
                                <span class="previous-level-title medium">متوسط</span>
                                <span class="previous-level-stats">${previousResults.medium_stats}</span>
                            </div>
                            <div class="previous-difficulty-level">
                                <span class="previous-level-title hard">صعب</span>
                                <span class="previous-level-stats">${previousResults.hard_stats}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } else if (data.status === 'empty') {
            previousResultsContent.innerHTML = `
                <div class="no-previous-results">
                    <i class="fas fa-info-circle"></i>
                    هذه هي أول محاولة لك
                </div>
            `;
        }
    } catch (error) {
        console.error('حدث خطأ أثناء جلب النتائج السابقة:', error);
        previousResultsContent.innerHTML = `
            <div class="error-loading-results">
                <i class="fas fa-exclamation-triangle"></i>
                <p>حدث خطأ أثناء تحميل النتائج السابقة</p>
            </div>
        `;
    }
}








function showSaveButton() {
    // تجنب إضافة الزر إذا كان موجوداً بالفعل
    if (document.getElementById('save-btn')) return;
    
    const buttonsContainer = document.querySelector('.buttons-container');
    
    const saveButton = document.createElement('button');
    saveButton.className = 'btn btn-primary';
    saveButton.id = 'save-btn';
    saveButton.innerHTML = '<i class="fas fa-save"></i> حفظ النتائج';
    saveButton.onclick = async () => {
        const realName = getRealName();
        if (!realName) {
            const name = await requestRealName();
            if (name) {
                await sendResultsToDatabase(name);
            }
        } else {
            await sendResultsToDatabase(realName);
        }
    };
    
    buttonsContainer.insertBefore(saveButton, buttonsContainer.firstChild);
}











        // نسخة متقدمة من زر التحديث
document.getElementById('refresh-btn').addEventListener('click', function() {
    const btn = this;
    const icon = btn.querySelector('i');
    
    // إظهار رسالة تأكيد بنفس الشكل القديم
    Swal.fire({
        title: 'تحديث الصفحة',
        text: 'جاري جلب أحدث نسخة من المحتوى...',
        icon: 'info',
        showConfirmButton: false,
        allowOutsideClick: false,
        willOpen: () => {
            // بدء تأثير التحميل
            btn.style.pointerEvents = 'none';
            icon.classList.add('fa-spin');
            
            // إعادة تحميل الصفحة مع تجاوز الكاش
            setTimeout(() => {
                window.location.href = window.location.href.split('?')[0] + '?t=' + new Date().getTime();
            }, 800);
        }
    });
});



</script>
</body>
</html>
